<div id="split-container">
  <div id="pdf-container">
    <iframe id="pdf-viewer" src="pdfjs/web/viewer.html?file=AntminerS9FanRemoval.pdf"></iframe>
    <script src="pdfjs/web/pdf-highlighter.js"></script>
  </div>
  <div id="dragbar"></div>
  <div id="unity-container">
    <canvas id="unity-canvas" width="960" height="600" tabindex="-1"></canvas>
    <div id="unity-loading-bar">
      <div id="unity-logo"></div>
      <div id="unity-progress-bar-empty">
        <div id="unity-progress-bar-full"></div>
      </div>
    </div>
    <div id="unity-warning"></div>
    <!-- Instruction Overlay scoped to Unity container only -->
    <div id="instruction-overlay" class="instruction-overlay">
      Click the ASIC miner to begin
    </div>
  </div>
</div>

<!-- Watermark Image -->
<img class="watermark" src="watermark-400x100.png" alt="IVE Logo">

<script>
  window.addEventListener("load", function () {
    if ("serviceWorker" in navigator) {
      navigator.serviceWorker.register("ServiceWorker.js");
    }
  });

  var container = document.querySelector("#unity-container");
  var canvas = document.querySelector("#unity-canvas");
  var loadingBar = document.querySelector("#unity-loading-bar");
  var progressBarFull = document.querySelector("#unity-progress-bar-full");
  var warningBanner = document.querySelector("#unity-warning");

  function unityShowBanner(msg, type) {
    function updateBannerVisibility() {
      warningBanner.style.display = warningBanner.children.length ? 'block' : 'none';
    }
    var div = document.createElement('div');
    div.innerHTML = msg;
    warningBanner.appendChild(div);
    if (type == 'error') {
      div.style = 'background: red; padding: 10px;';
    } else if (type == 'warning') {
      div.style = 'background: yellow; padding: 10px;';
      setTimeout(() => {
        warningBanner.removeChild(div);
        updateBannerVisibility();
      }, 5000);
    }
    updateBannerVisibility();
  }

  function checkHardwareAcceleration() {
    var testCanvas = document.createElement('canvas');
    var gl = testCanvas.getContext('webgl') || testCanvas.getContext('experimental-webgl');
    if (!gl) return false;
    var debugInfo = gl.getExtension('WEBGL_debug_renderer_info');
    if (debugInfo) {
      var renderer = gl.getParameter(debugInfo.UNMASKED_RENDERER_WEBGL);
      return !renderer.toLowerCase().includes("swiftshader");
    }
    return true;
  }

  var buildUrl = "Build";
  var loaderUrl = buildUrl + "/WebGL.loader.js";
  var config = {
    arguments: [],
    dataUrl: buildUrl + "/WebGL.data.br",
    frameworkUrl: buildUrl + "/WebGL.framework.js.br",
    codeUrl: buildUrl + "/WebGL.wasm.br",
    streamingAssetsUrl: "StreamingAssets",
    companyName: "IVE",
    productName: "Miner Workbench",
    productVersion: "0.1.0",
    showBanner: unityShowBanner,
  };

  if (!checkHardwareAcceleration()) {
    unityShowBanner("Hardware acceleration appears to be disabled. Please enable it for best performance.", "warning");
  }

  if (/iPhone|iPad|iPod|Android/i.test(navigator.userAgent)) {
    var meta = document.createElement('meta');
    meta.name = 'viewport';
    meta.content = 'width=device-width, height=device-height, initial-scale=1.0, user-scalable=no, shrink-to-fit=yes';
    document.head.appendChild(meta);
  }

  loadingBar.style.display = "block";
  var script = document.createElement("script");
  script.src = loaderUrl;
  script.onload = () => {
    createUnityInstance(canvas, config, (progress) => {
      progressBarFull.style.width = 100 * progress + "%";
    }).then(() => {
      loadingBar.style.display = "none";
    }).catch((message) => {
      alert(message);
    });
  };
  document.body.appendChild(script);

  let firstClickHandled = false;
  canvas.addEventListener("mousedown", () => {
    if (firstClickHandled) return;
    firstClickHandled = true;
    document.getElementById("instruction-overlay").innerHTML = `
      <strong>Tool Instructions:</strong><br>
      Right-Click + Hold & Drag: Rotate the Miner X & Y<br>
      Left-Click + Hold & Drag: Rotate the Miner Z<br>
      Middle Mouse Roll: Zoom In/Out<br>
      Mouse Over: Clickable Parts will Highlight Green
    `;
  });

  (function() {
    var dragbar = document.getElementById("dragbar");
    var pdfContainer = document.getElementById("pdf-container");
    var splitContainer = document.getElementById("split-container");
    var dragging = false;

    dragbar.addEventListener("mousedown", function(e) {
      dragging = true;
      document.body.style.cursor = "col-resize";
      e.preventDefault();
    });

    document.addEventListener("mousemove", function(e) {
      if (!dragging) return;
      var offset = e.clientX - splitContainer.offsetLeft;
      var minWidth = 100;
      var containerWidth = splitContainer.offsetWidth;
      if (offset < minWidth) offset = minWidth;
      if (containerWidth - offset < minWidth) offset = containerWidth - minWidth;
      pdfContainer.style.flexBasis = offset + "px";
    });

    document.addEventListener("mouseup", function() {
      if (dragging) {
        dragging = false;
        document.body.style.cursor = "default";
      }
    });
  })();

  function highlightPDFText(searchText) {
    var pdfIframe = document.querySelector("#pdf-viewer");
    if (pdfIframe) {
      pdfIframe.contentWindow.postMessage({ type: "highlight", text: searchText }, "*");
    } else {
      console.error("PDF iframe not found.");
    }
  }
  window.unityHighlightPDF = highlightPDFText;

  function acceptTerms() {
    document.getElementById("terms-modal").style.display = "none";
    document.body.classList.add("terms-accepted");
  }
</script>

<!-- Footer -->
<footer>Â©2025 Interactive Virtual Experiences. All rights reserved.</footer>
